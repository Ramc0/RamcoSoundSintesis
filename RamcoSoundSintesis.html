<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RamcoSoundSintesis</title>

    <style>
        body {
            margin: 0;
            overflow: hidden;
            background: radial-gradient(circle at center, #1b2735, #090a0f);
        }

        canvas {
            display: block;
        }

        #controls {
            position: fixed;
            top: 20px;
            left: 20px;
            background: linear-gradient(145deg, #1f1f1f, #2c2c2c);
            padding: 20px;
            border-radius: 12px;
            color: white;
            font-family: sans-serif;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
            width: 240px;
        }

        #controls h3 {
            margin: 0 0 15px 0;
            color: #40C4FF;
            text-align: center;
        }

        .control-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        #controls select {
            background: #111;
            color: #40C4FF;
            border: 1px solid #40C4FF;
            border-radius: 6px;
            padding: 4px 6px;
            width: 120px;
        }

        #controls button {
            display: block;
            margin: 15px auto 0 auto;
            width: 80%;
            background: #ff5252;
            border: none;
            color: white;
            padding: 6px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: 0.2s;
        }

        #controls button:hover {
            background: #ff1744;
            transform: scale(1.03);
        }
    </style>
</head>

<body>

    <div id="controls">
        <h3>RamcoSoundSintesis</h3>

        <div class="control-row">
            <label>Escala:</label>
            <select id="scaleSelector">
                <option value="major">Mayor</option>
                <option value="minor">Menor</option>
                <option value="pentatonic">Pentatónica</option>
            </select>
        </div>

        <div class="control-row">
            <label>Tonalidad:</label>
            <select id="rootSelector">
                <option value="60">C</option>
                <option value="62">D</option>
                <option value="64">E</option>
                <option value="65">F</option>
                <option value="67">G</option>
                <option value="69">A</option>
                <option value="71">B</option>
            </select>
        </div>

        <div class="control-row">
            <label>Onda:</label>
            <select id="waveSelector">
                <option value="sine">Seno</option>
                <option value="square">Cuadrada</option>
                <option value="triangle">Triangular</option>
                <option value="sawtooth">Sierra</option>
            </select>
        </div>

        <div class="control-row">
            <label>Armonía:</label>
            <select id="harmonySelector">
                <option value="single">Nota sola</option>
                <option value="fifth">Quinta</option>
                <option value="majorChord">Acorde Mayor</option>
                <option value="minorChord">Acorde Menor</option>
            </select>
        </div>

        <button id="clearBalls">Borrar todas las bolas</button>
    </div>

    <canvas id="canvas"></canvas>

    <script>

        // ============================================================
        // INICIALIZACIÓN
        // ============================================================

        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        const BALL_RGB = { r: 64, g: 196, b: 255 };

        // ============================================================
        // MOTOR MUSICAL
        // ============================================================

        const scales = {
            major: [0, 2, 4, 5, 7, 9, 11],
            minor: [0, 2, 3, 5, 7, 8, 10],
            pentatonic: [0, 3, 5, 7, 10]
        };

        let currentScale = 'major';
        let rootMidi = 60;
        let currentWave = 'sine';
        let harmonyMode = 'single';

        function midiToFreq(midi) {
            return 440 * Math.pow(2, (midi - 69) / 12);
        }

        function generateScaleNotes(baseMidi) {
            return scales[currentScale].map(i => baseMidi + i);
        }

        let bassNotes = generateScaleNotes(rootMidi - 12);
        let trebleNotes = generateScaleNotes(rootMidi + 12);

        function updateScale() {
            bassNotes = generateScaleNotes(rootMidi - 12);
            trebleNotes = generateScaleNotes(rootMidi + 12);
        }

        // ============================================================
        // ESCENA
        // ============================================================

        let leftCenterX = canvas.width * 0.3;
        let rightCenterX = canvas.width * 0.7;
        let centerY = canvas.height / 2;
        const radius = Math.min(canvas.width, canvas.height) * 0.35;

        const bassBalls = [];
        const trebleBalls = [];
        let activeOscillators = 0;

        let isDragging = false;
        let dragStartX, dragStartY, dragEndX, dragEndY;
        let currentCircle = null;

        // ============================================================
        // DIBUJO
        // ============================================================

        function drawCircles() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            ctx.strokeStyle = '#aaa';
            ctx.lineWidth = 8;

            ctx.beginPath();
            ctx.arc(leftCenterX, centerY, radius, 0, Math.PI * 2);
            ctx.stroke();
            drawArcs(bassNotes, leftCenterX);

            ctx.beginPath();
            ctx.arc(rightCenterX, centerY, radius, 0, Math.PI * 2);
            ctx.stroke();
            drawArcs(trebleNotes, rightCenterX);
        }

        function drawArcs(notes, centerX) {
            const arcAngle = (2 * Math.PI) / notes.length;

            notes.forEach((_, i) => {
                ctx.strokeStyle = '#40C4FF';
                ctx.beginPath();
                ctx.arc(centerX, centerY, radius, i * arcAngle, (i + 1) * arcAngle);
                ctx.stroke();
            });
        }

        function drawBalls() {
            [...bassBalls, ...trebleBalls].forEach(ball => {
                for (let i = 0; i < 5; i++) {
                    const alpha = 0.1 * (5 - i);
                    ctx.fillStyle = `rgba(${BALL_RGB.r},${BALL_RGB.g},${BALL_RGB.b},${alpha})`;
                    ctx.beginPath();
                    ctx.arc(ball.x - ball.dx * i * 0.5, ball.y - ball.dy * i * 0.5, ball.radius + i * 0.5, 0, Math.PI * 2);
                    ctx.fill();
                }

                const gradient = ctx.createRadialGradient(ball.x, ball.y, ball.radius * 0.5, ball.x, ball.y, ball.radius * 2);
                gradient.addColorStop(0, 'rgba(64,196,255,1)');
                gradient.addColorStop(1, 'transparent');

                ctx.fillStyle = gradient;
                ctx.beginPath();
                ctx.arc(ball.x, ball.y, ball.radius * 2, 0, Math.PI * 2);
                ctx.fill();

                ctx.fillStyle = '#40C4FF';
                ctx.beginPath();
                ctx.arc(ball.x, ball.y, ball.radius, 0, Math.PI * 2);
                ctx.fill();
            });
        }

        function drawPreviewLine() {
            if (isDragging && currentCircle) {
                ctx.strokeStyle = 'rgba(255,255,255,0.7)';
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.moveTo(dragStartX, dragStartY);
                ctx.lineTo(dragEndX, dragEndY);
                ctx.stroke();
            }
        }

        // ============================================================
        // FÍSICA
        // ============================================================

        function updateCircleBalls(balls, centerX, notes) {
            balls.forEach(ball => {
                ball.x += ball.dx;
                ball.y += ball.dy;

                const dist = Math.hypot(ball.x - centerX, ball.y - centerY);

                if (dist + ball.radius >= radius) {

                    const angle = Math.atan2(ball.y - centerY, ball.x - centerX);
                    const arcAngle = (2 * Math.PI) / notes.length;
                    const index = Math.floor((angle + 2 * Math.PI) % (2 * Math.PI) / arcAngle);

                    if (index >= 0 && index < notes.length)
                        playHarmony(notes[index]);

                    const nx = (ball.x - centerX) / dist;
                    const ny = (ball.y - centerY) / dist;
                    const dot = ball.dx * nx + ball.dy * ny;

                    ball.dx -= 2 * dot * nx;
                    ball.dy -= 2 * dot * ny;
                }
            });
        }

        function handleBallCollisions(balls) {
            for (let i = 0; i < balls.length; i++) {
                for (let j = i + 1; j < balls.length; j++) {

                    const b1 = balls[i];
                    const b2 = balls[j];

                    const dx = b2.x - b1.x;
                    const dy = b2.y - b1.y;
                    const dist = Math.hypot(dx, dy);

                    if (dist === 0 || dist > b1.radius + b2.radius) continue;

                    const nx = dx / dist;
                    const ny = dy / dist;

                    const p = 2 * (b1.dx * nx + b1.dy * ny - b2.dx * nx - b2.dy * ny) / 2;

                    b1.dx -= p * nx;
                    b1.dy -= p * ny;
                    b2.dx += p * nx;
                    b2.dy += p * ny;

                    playHarmony(rootMidi);
                }
            }
        }

        function updateBalls() {
            updateCircleBalls(bassBalls, leftCenterX, bassNotes);
            updateCircleBalls(trebleBalls, rightCenterX, trebleNotes);
            handleBallCollisions(bassBalls);
            handleBallCollisions(trebleBalls);
        }

        // ============================================================
        // AUDIO
        // ============================================================

        function playNote(midi) {
            const now = audioCtx.currentTime;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();

            osc.type = currentWave;
            osc.frequency.value = midiToFreq(midi);

            const value = 0.5 / (activeOscillators + 1);

            gain.gain.setValueAtTime(0, now);
            gain.gain.linearRampToValueAtTime(value, now + 0.01);
            gain.gain.exponentialRampToValueAtTime(0.001, now + 1);

            osc.connect(gain);
            gain.connect(audioCtx.destination);

            osc.start(now);
            osc.stop(now + 1);

            activeOscillators++;
            osc.onended = () => activeOscillators--;
        }

        function playHarmony(midi) {
            if (harmonyMode === 'single') playNote(midi);
            if (harmonyMode === 'fifth') { playNote(midi); playNote(midi + 7); }
            if (harmonyMode === 'majorChord') { playNote(midi); playNote(midi + 4); playNote(midi + 7); }
            if (harmonyMode === 'minorChord') { playNote(midi); playNote(midi + 3); playNote(midi + 7); }
        }

        // ============================================================
        // INTERACCIÓN
        // ============================================================

        function createBall(x, y, dx, dy, circle) {
            const ball = { x, y, radius: 12, dx, dy };
            circle === 'bass' ? bassBalls.push(ball) : trebleBalls.push(ball);
        }

        function animate() {
            drawCircles();
            updateBalls();
            drawBalls();
            drawPreviewLine();
            requestAnimationFrame(animate);
        }

        canvas.addEventListener('mousedown', e => {
            const rect = canvas.getBoundingClientRect();
            dragStartX = e.clientX - rect.left;
            dragStartY = e.clientY - rect.top;

            const distLeft = Math.hypot(dragStartX - leftCenterX, dragStartY - centerY);
            const distRight = Math.hypot(dragStartX - rightCenterX, dragStartY - centerY);

            if (distLeft <= radius) currentCircle = 'bass';
            else if (distRight <= radius) currentCircle = 'treble';
            else currentCircle = null;

            isDragging = !!currentCircle;
        });
        canvas.addEventListener('mousemove', e => {
            if (!isDragging) return;

            const rect = canvas.getBoundingClientRect();
            dragEndX = e.clientX - rect.left;
            dragEndY = e.clientY - rect.top;
        });

        canvas.addEventListener('mouseup', e => {
            if (!isDragging) return;

            const rect = canvas.getBoundingClientRect();
            dragEndX = e.clientX - rect.left;
            dragEndY = e.clientY - rect.top;

            const dx = (dragStartX - dragEndX) * 0.1;
            const dy = (dragStartY - dragEndY) * 0.1;

            createBall(dragStartX, dragStartY, dx, dy, currentCircle);

            isDragging = false;
            currentCircle = null;
        });

        window.addEventListener('resize', () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            leftCenterX = canvas.width * 0.3;
            rightCenterX = canvas.width * 0.7;
            centerY = canvas.height / 2;
        });

        // Controles
        document.getElementById('scaleSelector').onchange = e => { currentScale = e.target.value; updateScale(); };
        document.getElementById('rootSelector').onchange = e => { rootMidi = parseInt(e.target.value); updateScale(); };
        document.getElementById('waveSelector').onchange = e => currentWave = e.target.value;
        document.getElementById('harmonySelector').onchange = e => harmonyMode = e.target.value;
        document.getElementById('clearBalls').onclick = () => { bassBalls.length = 0; trebleBalls.length = 0; };

        animate();

    </script>
</body>

</html>